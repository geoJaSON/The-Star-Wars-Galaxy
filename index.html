<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Galaxy Far, Far Away...</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: #000;
            color: #00d4ff;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Side panel */
        .side-panel {
            width: 320px;
            background: linear-gradient(180deg, #0a0a12 0%, #050508 100%);
            border-right: 3px solid #c41e3a;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1000;
            overflow: hidden;
        }

        .side-panel::before {
            content: '';
            position: absolute;
            top: 0;
            right: -6px;
            width: 3px;
            height: 100%;
            background: #00d4ff;
            opacity: 0.3;
        }

        .title-section {
            padding: 15px 20px;
            border-bottom: 2px solid #c41e3a;
            background: linear-gradient(180deg, #1a0a0a 0%, #0a0a12 100%);
        }

        .main-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 900;
            color: #c41e3a;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #c41e3a, 0 0 20px #c41e3a;
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 0.65rem;
            color: #666;
            letter-spacing: 1px;
        }

        /* Search section */
        .search-section {
            padding: 12px 20px;
            border-bottom: 1px solid #1a3a4a;
            background: rgba(0, 20, 30, 0.5);
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            background: #0a0a12;
            border: 2px solid #1a3a4a;
            color: #00d4ff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .search-input::placeholder {
            color: #4a7a8a;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0a0a12;
            border: 2px solid #00d4ff;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #1a3a4a;
            font-size: 0.75rem;
        }

        .search-result-item:hover {
            background: #1a3a4a;
        }

        .search-result-item .name {
            color: #00d4ff;
        }

        .search-result-item .region {
            color: #4a7a8a;
            font-size: 0.65rem;
        }

        /* Quick jump section */
        .quickjump-section {
            padding: 12px 20px;
            border-bottom: 1px solid #1a3a4a;
        }

        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: #00d4ff;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quickjump-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .quickjump-btn {
            padding: 6px 4px;
            background: #0a0a12;
            border: 1px solid #1a3a4a;
            color: #8ab4c4;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .quickjump-btn:hover {
            background: #1a3a4a;
            border-color: #00d4ff;
            color: #00d4ff;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        /* Region filters */
        .filter-section {
            padding: 12px 20px;
            border-bottom: 1px solid #1a3a4a;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            background: transparent;
            border: 1px solid transparent;
            color: #6a8a9a;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            color: #00d4ff;
        }

        .filter-btn:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .filter-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .filter-btn.active .filter-dot {
            opacity: 1;
            box-shadow: 0 0 6px currentColor;
        }

        /* Stats section */
        .stats-section {
            padding: 10px 20px;
            border-bottom: 1px solid #1a3a4a;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }

        .stat-label { color: #4a7a8a; }
        .stat-value { color: #00d4ff; font-family: 'Orbitron', sans-serif; }

        /* Info panel */
        .info-panel {
            flex: 1;
            padding: 12px 20px;
            overflow-y: auto;
        }

        .info-panel::-webkit-scrollbar { width: 6px; }
        .info-panel::-webkit-scrollbar-track { background: #0a0a12; }
        .info-panel::-webkit-scrollbar-thumb { background: #1a3a4a; border-radius: 3px; }

        /* Footer section */
        .footer-section {
            padding: 12px 20px;
            border-top: 1px solid #1a3a4a;
            background: rgba(0, 10, 15, 0.5);
        }

        .github-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #4a7a8a;
            text-decoration: none;
            font-size: 0.65rem;
            padding: 8px;
            border: 1px solid #1a3a4a;
            transition: all 0.2s;
        }

        .github-link:hover {
            color: #00d4ff;
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .github-link svg {
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .github-link:hover svg {
            opacity: 1;
        }

        .info-content {
            font-size: 0.7rem;
            line-height: 1.5;
            color: #8ab4c4;
        }

        .info-content .planet-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            color: #00d4ff;
            margin-bottom: 8px;
            text-shadow: 0 0 10px #00d4ff;
        }

        .info-content .detail {
            margin-bottom: 3px;
        }

        .info-content .detail-label {
            color: #4a7a8a;
        }

        .info-content .description {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #1a3a4a;
            font-size: 0.65rem;
            color: #6a9aaa;
        }

        /* Map container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #000;
        }

        /* CSS Grid overlay - much more performant than SVG lines */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 400;
            background-image:
                linear-gradient(rgba(26, 58, 74, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(26, 58, 74, 0.3) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.5;
        }

        /* Leaflet overrides */
        .leaflet-container {
            background: #000 !important;
            font-family: 'Share Tech Mono', monospace;
        }

        .leaflet-control-zoom {
            border: 2px solid #1a3a4a !important;
            background: #0a0a12 !important;
        }

        .leaflet-control-zoom a {
            background: #0a0a12 !important;
            color: #00d4ff !important;
            border-color: #1a3a4a !important;
        }

        .leaflet-control-zoom a:hover {
            background: #1a3a4a !important;
        }

        /* Planet labels */
        .planet-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 9px;
            color: #8ab4c4;
            text-shadow: 0 0 3px #000, 1px 1px 2px #000, -1px -1px 2px #000;
            white-space: nowrap;
            pointer-events: none;
        }

        .planet-label.major {
            font-size: 11px;
            color: #00d4ff;
            font-weight: bold;
            text-shadow: 0 0 5px #00d4ff, 0 0 10px #000;
        }

        /* Tooltips */
        .leaflet-tooltip.custom-tooltip {
            background: rgba(10, 10, 18, 0.95) !important;
            border: 1px solid #00d4ff !important;
            border-radius: 0 !important;
            color: #00d4ff !important;
            font-family: 'Share Tech Mono', monospace !important;
            font-size: 11px !important;
            padding: 6px 10px !important;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3) !important;
        }

        .leaflet-tooltip.custom-tooltip::before {
            border-top-color: #00d4ff !important;
        }

        .popup-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .popup-detail {
            font-size: 10px;
            color: #8ab4c4;
        }

        .popup-detail span {
            color: #4a7a8a;
        }

        /* Scan lines */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            opacity: 0.25;
        }

        /* Corner decorations */
        .corner-decor {
            position: absolute;
            width: 40px;
            height: 40px;
            z-index: 1001;
            pointer-events: none;
        }

        .corner-decor.top-right {
            top: 10px;
            right: 10px;
            border-top: 3px solid #00d4ff;
            border-right: 3px solid #00d4ff;
        }

        .corner-decor.bottom-right {
            bottom: 10px;
            right: 10px;
            border-bottom: 3px solid #00d4ff;
            border-right: 3px solid #00d4ff;
        }

        .corner-decor.bottom-left {
            bottom: 10px;
            left: 10px;
            border-bottom: 3px solid #c41e3a;
            border-left: 3px solid #c41e3a;
        }

        /* Coordinates display */
        .grid-coords {
            position: absolute;
            bottom: 15px;
            right: 60px;
            background: rgba(10, 10, 18, 0.85);
            border: 1px solid #1a3a4a;
            padding: 6px 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            color: #00d4ff;
            z-index: 1001;
        }

        /* Loading screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 3px;
            animation: pulse 1.5s infinite;
        }

        .loading-bar {
            width: 200px;
            height: 3px;
            background: #1a3a4a;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-bar-fill {
            height: 100%;
            background: #00d4ff;
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 10px #00d4ff;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Animated hyperlane styles */
        .hyperlane-animated {
            stroke-dasharray: 8 4;
            animation: flowDash 1s linear infinite;
        }

        @keyframes flowDash {
            to { stroke-dashoffset: -12; }
        }

        /* Targeting crosshair animation */
        .targeting-reticle {
            position: absolute;
            pointer-events: none;
            z-index: 2000;
            transform: translate(-50%, -50%);
        }

        .reticle-ring {
            position: absolute;
            border: 2px solid #c41e3a;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            box-shadow: 0 0 10px #c41e3a, inset 0 0 10px rgba(196, 30, 58, 0.3);
        }

        .reticle-ring.outer {
            width: 120px;
            height: 120px;
            animation: reticleOuter 0.8s ease-out forwards;
        }

        .reticle-ring.middle {
            width: 80px;
            height: 80px;
            animation: reticleMiddle 0.8s ease-out 0.1s forwards;
        }

        .reticle-ring.inner {
            width: 40px;
            height: 40px;
            border-color: #00d4ff;
            box-shadow: 0 0 10px #00d4ff, inset 0 0 10px rgba(0, 212, 255, 0.3);
            animation: reticleInner 0.8s ease-out 0.2s forwards;
        }

        .reticle-crosshair {
            position: absolute;
            background: #00d4ff;
            box-shadow: 0 0 8px #00d4ff;
            opacity: 0;
        }

        .reticle-crosshair.horizontal {
            width: 150px;
            height: 2px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scaleX(0);
            animation: crosshairH 0.5s ease-out 0.3s forwards;
        }

        .reticle-crosshair.vertical {
            width: 2px;
            height: 150px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scaleY(0);
            animation: crosshairV 0.5s ease-out 0.3s forwards;
        }

        .reticle-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: #c41e3a;
            border-style: solid;
            border-width: 0;
            opacity: 0;
            box-shadow: 0 0 5px #c41e3a;
        }

        .reticle-corner.tl { top: -40px; left: -40px; border-top-width: 3px; border-left-width: 3px; animation: cornerIn 0.4s ease-out 0.4s forwards, cornerPulse 1s ease-in-out 0.8s infinite; }
        .reticle-corner.tr { top: -40px; right: -40px; border-top-width: 3px; border-right-width: 3px; animation: cornerIn 0.4s ease-out 0.45s forwards, cornerPulse 1s ease-in-out 0.85s infinite; }
        .reticle-corner.bl { bottom: -40px; left: -40px; border-bottom-width: 3px; border-left-width: 3px; animation: cornerIn 0.4s ease-out 0.5s forwards, cornerPulse 1s ease-in-out 0.9s infinite; }
        .reticle-corner.br { bottom: -40px; right: -40px; border-bottom-width: 3px; border-right-width: 3px; animation: cornerIn 0.4s ease-out 0.55s forwards, cornerPulse 1s ease-in-out 0.95s infinite; }

        .reticle-text {
            position: absolute;
            top: -70px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 2px;
            white-space: nowrap;
            opacity: 0;
            text-shadow: 0 0 10px #00d4ff;
            animation: textIn 0.3s ease-out 0.5s forwards;
        }

        .reticle-coords {
            position: absolute;
            bottom: -65px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: #c41e3a;
            white-space: nowrap;
            opacity: 0;
            animation: textIn 0.3s ease-out 0.6s forwards;
        }

        @keyframes reticleOuter {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
            50% { opacity: 1; }
            100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes reticleMiddle {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(1.8); }
            50% { opacity: 1; }
            100% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes reticleInner {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes crosshairH {
            0% { opacity: 0; transform: translate(-50%, -50%) scaleX(0); }
            100% { opacity: 1; transform: translate(-50%, -50%) scaleX(1); }
        }

        @keyframes crosshairV {
            0% { opacity: 0; transform: translate(-50%, -50%) scaleY(0); }
            100% { opacity: 1; transform: translate(-50%, -50%) scaleY(1); }
        }

        @keyframes cornerIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes cornerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes textIn {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            100% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Lock confirmation flash */
        .reticle-flash {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.4) 0%, transparent 70%);
            opacity: 0;
            animation: lockFlash 0.6s ease-out 0.7s forwards;
        }

        @keyframes lockFlash {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-text">Initializing Galactic Database...</div>
        <div class="loading-bar"><div class="loading-bar-fill" id="loading-bar"></div></div>
    </div>

    <div class="scanlines"></div>

    <div class="container">
        <div class="side-panel">
            <div class="title-section">
                <div class="main-title">The Galaxy Far, Far Away...</div>
                <div class="subtitle">Interactive Galactic Map // Expanded Universe</div>
            </div>

            <div class="search-section">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="Search systems..." autocomplete="off">
                    <div class="search-results" id="search-results"></div>
                </div>
            </div>

            <div class="quickjump-section">
                <div class="section-title">Quick Jump</div>
                <div class="quickjump-grid" id="quickjump-grid"></div>
            </div>

            <div class="filter-section">
                <div class="section-title">Region Filters</div>
                <div class="filter-grid" id="filter-grid"></div>
            </div>

            <div class="stats-section">
                <div class="stat-row">
                    <span class="stat-label">Visible Systems:</span>
                    <span class="stat-value" id="visible-count">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Catalogued:</span>
                    <span class="stat-value" id="planet-count">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hyperlanes:</span>
                    <span class="stat-value" id="route-count">--</span>
                </div>
            </div>

            <div class="info-panel">
                <div class="section-title">System Information</div>
                <div class="info-content" id="system-info">
                    <div style="color: #4a7a8a; font-style: italic;">
                        Select a system to view details...
                    </div>
                </div>
            </div>

            <div class="footer-section">
                <a href="https://github.com/geoJaSON/The-Star-Wars-Galaxy" target="_blank" class="github-link">
                    <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    View on GitHub
                </a>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="grid-overlay"></div>
            <div class="corner-decor top-right"></div>
            <div class="corner-decor bottom-right"></div>
            <div class="corner-decor bottom-left"></div>
            <div class="grid-coords" id="coords">COORDS: --</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            regions: {
                'Core Worlds': { color: '#ffd700', order: 1 },
                'Deep Core': { color: '#ffd700', order: 0 },
                'Colonies': { color: '#00ff88', order: 2 },
                'Inner Rim': { color: '#00d4ff', order: 3 },
                'Expansion Region': { color: '#ff6b00', order: 4 },
                'Mid Rim': { color: '#ff00ff', order: 5 },
                'Outer Rim Territories': { color: '#ff3366', order: 6 },
                'Hutt Space': { color: '#8b4513', order: 7 },
                'Wild Space': { color: '#666666', order: 8 },
                'Unknown Regions': { color: '#444444', order: 9 }
            },
            famousPlanets: [
                'Coruscant', 'Tatooine', 'Hoth', 'Endor', 'Naboo', 'Mustafar',
                'Kashyyyk', 'Dagobah', 'Bespin', 'Alderaan', 'Kamino', 'Geonosis'
            ],
            labelZoomThresholds: {
                5: 2,  // Only major planets (intensity 5) at low zoom
                4: 5,  // Important planets need zoom 5+
                3: 6,  // Medium planets need zoom 6+
                2: 7,  // Minor planets need zoom 7+
                1: 8   // Tiny planets only at max zoom
            }
        };

        // ============================================
        // STATE
        // ============================================
        let planetsData = [];
        let hyperlanesData = [];
        let activeFilters = new Set(Object.keys(CONFIG.regions));
        let visibleMarkers = new Map();
        let labelsLayer = null;
        let markersLayer = null;
        let hyperlanesLayer = null;
        let hyperlaneGlowLayer = null;

        // ============================================
        // MAP INITIALIZATION (with Canvas renderer!)
        // ============================================
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: 1,
            maxZoom: 12,
            zoomControl: true,
            attributionControl: false,
            renderer: L.canvas({ padding: 0.5 }), // CANVAS RENDERER - huge performance boost
            preferCanvas: true
        });

        map.setView([-12, 14], 3);

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function getRegionColor(region) {
            return CONFIG.regions[region]?.color || '#666666';
        }

        function updateLoadingBar(percent) {
            document.getElementById('loading-bar').style.width = percent + '%';
        }

        // ============================================
        // TARGETING RETICLE ANIMATION
        // ============================================
        let activeReticle = null;

        function showTargetingReticle(latlng, planetName, gridCoords) {
            // Remove any existing reticle
            if (activeReticle) {
                activeReticle.remove();
            }

            // Get screen position from map coordinates
            const point = map.latLngToContainerPoint(latlng);

            // Create reticle container
            const reticle = document.createElement('div');
            reticle.className = 'targeting-reticle';
            reticle.style.left = point.x + 'px';
            reticle.style.top = point.y + 'px';

            reticle.innerHTML = `
                <div class="reticle-flash"></div>
                <div class="reticle-ring outer"></div>
                <div class="reticle-ring middle"></div>
                <div class="reticle-ring inner"></div>
                <div class="reticle-crosshair horizontal"></div>
                <div class="reticle-crosshair vertical"></div>
                <div class="reticle-corner tl"></div>
                <div class="reticle-corner tr"></div>
                <div class="reticle-corner bl"></div>
                <div class="reticle-corner br"></div>
                <div class="reticle-text">Target Acquired</div>
                <div class="reticle-coords">${planetName}${gridCoords ? ' // ' + gridCoords : ''}</div>
            `;

            document.querySelector('.map-container').appendChild(reticle);
            activeReticle = reticle;

            // Play a subtle "lock" sound effect feel by flashing the whole thing
            setTimeout(() => {
                reticle.style.filter = 'brightness(1.5)';
                setTimeout(() => {
                    reticle.style.filter = '';
                }, 100);
            }, 700);

            // Remove after animation completes
            setTimeout(() => {
                if (reticle.parentNode) {
                    reticle.style.opacity = '0';
                    reticle.style.transition = 'opacity 0.5s';
                    setTimeout(() => reticle.remove(), 500);
                }
                if (activeReticle === reticle) {
                    activeReticle = null;
                }
            }, 2500);
        }

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', debounce(function(e) {
            const query = e.target.value.toLowerCase().trim();

            if (query.length < 2) {
                searchResults.classList.remove('active');
                return;
            }

            const matches = planetsData
                .filter(p => p.properties.name.toLowerCase().includes(query))
                .slice(0, 15)
                .sort((a, b) => {
                    const aStarts = a.properties.name.toLowerCase().startsWith(query);
                    const bStarts = b.properties.name.toLowerCase().startsWith(query);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return (b.properties.intensity || 1) - (a.properties.intensity || 1);
                });

            if (matches.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item"><span class="name">No systems found</span></div>';
            } else {
                searchResults.innerHTML = matches.map(p => `
                    <div class="search-result-item" data-coords="${p.geometry.coordinates.join(',')}">
                        <div class="name">${p.properties.name}</div>
                        <div class="region">${p.properties.region || 'Unknown Region'}</div>
                    </div>
                `).join('');
            }

            searchResults.classList.add('active');
        }, 150));

        searchResults.addEventListener('click', function(e) {
            const item = e.target.closest('.search-result-item');
            if (item && item.dataset.coords) {
                const [lng, lat] = item.dataset.coords.split(',').map(Number);
                const latlng = L.latLng(lat, lng);

                map.setView(latlng, 6);
                searchResults.classList.remove('active');
                searchInput.value = '';

                // Find and show info for clicked planet
                const planet = planetsData.find(p =>
                    p.geometry.coordinates[0] === lng && p.geometry.coordinates[1] === lat
                );

                if (planet) {
                    updateSystemInfo(planet.properties);

                    // Show targeting reticle after map has moved
                    setTimeout(() => {
                        showTargetingReticle(
                            latlng,
                            planet.properties.name,
                            planet.properties.coordinates
                        );
                    }, 300);
                }
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('active');
            }
        });

        // ============================================
        // QUICK JUMP BUTTONS
        // ============================================
        function setupQuickJumps() {
            const grid = document.getElementById('quickjump-grid');

            CONFIG.famousPlanets.forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'quickjump-btn';
                btn.textContent = name;
                btn.addEventListener('click', () => jumpToPlanet(name));
                grid.appendChild(btn);
            });
        }

        function jumpToPlanet(name) {
            const planet = planetsData.find(p =>
                p.properties.name.toLowerCase() === name.toLowerCase()
            );

            if (planet) {
                const [lng, lat] = planet.geometry.coordinates;
                const latlng = L.latLng(lat, lng);

                map.setView(latlng, 6);
                updateSystemInfo(planet.properties);

                // Show targeting reticle after map has moved
                setTimeout(() => {
                    showTargetingReticle(
                        latlng,
                        planet.properties.name,
                        planet.properties.coordinates
                    );
                }, 300);
            }
        }

        // ============================================
        // REGION FILTERS
        // ============================================
        function setupFilters() {
            const grid = document.getElementById('filter-grid');

            Object.entries(CONFIG.regions)
                .sort((a, b) => a[1].order - b[1].order)
                .forEach(([region, config]) => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn active';
                    btn.dataset.region = region;
                    btn.innerHTML = `
                        <span class="filter-dot" style="background: ${config.color}; box-shadow: 0 0 6px ${config.color};"></span>
                        ${region.replace(' Territories', '').replace(' Region', '')}
                    `;
                    btn.addEventListener('click', () => toggleFilter(region, btn));
                    grid.appendChild(btn);
                });
        }

        function toggleFilter(region, btn) {
            if (activeFilters.has(region)) {
                activeFilters.delete(region);
                btn.classList.remove('active');
            } else {
                activeFilters.add(region);
                btn.classList.add('active');
            }
            updateVisibleMarkers();
        }

        // ============================================
        // SYSTEM INFO PANEL
        // ============================================
        function updateSystemInfo(properties) {
            const infoDiv = document.getElementById('system-info');

            let html = `<div class="planet-name">${properties.name || 'Unknown System'}</div>`;

            const fields = [
                { key: 'region', label: 'Region' },
                { key: 'sector', label: 'Sector' },
                { key: 'coordinates', label: 'Grid' },
                { key: 'climate', label: 'Climate' },
                { key: 'terrain', label: 'Terrain' },
                { key: 'population', label: 'Population' },
                { key: 'traderoutes', label: 'Trade Routes' },
                { key: 'poi', label: 'Notable' }
            ];

            fields.forEach(({ key, label }) => {
                if (properties[key]) {
                    html += `<div class="detail"><span class="detail-label">${label}:</span> ${properties[key]}</div>`;
                }
            });

            if (properties.description) {
                const desc = properties.description.length > 350
                    ? properties.description.substring(0, 350) + '...'
                    : properties.description;
                html += `<div class="description">${desc}</div>`;
            }

            infoDiv.innerHTML = html;
        }

        // ============================================
        // MARKER RENDERING (viewport culling)
        // ============================================
        function updateVisibleMarkers() {
            if (!markersLayer) return;

            const bounds = map.getBounds();
            const zoom = map.getZoom();
            let visibleCount = 0;

            markersLayer.eachLayer(marker => {
                const props = marker.feature?.properties;
                if (!props) return;

                const latlng = marker.getLatLng();
                const inBounds = bounds.contains(latlng);
                const regionVisible = activeFilters.has(props.region);

                if (inBounds && regionVisible) {
                    marker.setStyle({ opacity: 1, fillOpacity: 0.8 });
                    visibleCount++;
                } else if (!regionVisible) {
                    marker.setStyle({ opacity: 0, fillOpacity: 0 });
                } else {
                    marker.setStyle({ opacity: 0.3, fillOpacity: 0.3 });
                }
            });

            document.getElementById('visible-count').textContent = visibleCount.toLocaleString();
            updateLabels();
        }

        // ============================================
        // LABEL RENDERING (zoom-based)
        // ============================================
        function updateLabels() {
            if (!labelsLayer) return;

            labelsLayer.clearLayers();

            const bounds = map.getBounds();
            const zoom = map.getZoom();

            planetsData.forEach(planet => {
                const props = planet.properties;
                if (!activeFilters.has(props.region)) return;

                const intensity = props.intensity || 1;
                let showLabel = false;

                // Determine if label should show based on zoom and intensity
                for (const [minIntensity, minZoom] of Object.entries(CONFIG.labelZoomThresholds)) {
                    if (intensity >= parseInt(minIntensity) && zoom >= minZoom) {
                        showLabel = true;
                        break;
                    }
                }

                if (!showLabel) return;

                const [lng, lat] = planet.geometry.coordinates;
                const latlng = L.latLng(lat, lng);

                if (!bounds.contains(latlng)) return;

                const labelClass = intensity >= 4 ? 'planet-label major' : 'planet-label';
                const label = L.marker(latlng, {
                    icon: L.divIcon({
                        className: labelClass,
                        html: props.name,
                        iconSize: null,
                        iconAnchor: [-8, 4]
                    }),
                    interactive: false
                });
                labelsLayer.addLayer(label);
            });
        }

        const debouncedUpdateMarkers = debounce(updateVisibleMarkers, 100);

        // ============================================
        // HYPERLANE RENDERING (with animation)
        // ============================================
        function createHyperlanes(data) {
            // Glow layer (underneath)
            hyperlaneGlowLayer = L.layerGroup();

            // Main hyperlanes layer
            hyperlanesLayer = L.geoJSON(data, {
                style: feature => {
                    const isMajor = feature.properties.size === 'Major';
                    return {
                        color: isMajor ? '#00d4ff' : '#3a6a7a',
                        weight: isMajor ? 2.5 : 1.5,
                        opacity: isMajor ? 0.85 : 0.5,
                        lineCap: 'round',
                        lineJoin: 'round',
                        className: isMajor ? 'hyperlane-animated' : ''
                    };
                },
                coordsToLatLng: coords => L.latLng(coords[1], coords[0]),
                onEachFeature: (feature, layer) => {
                    if (feature.properties.name) {
                        layer.bindTooltip(feature.properties.name, {
                            className: 'custom-tooltip',
                            sticky: true
                        });
                    }
                }
            });

            // Create glow effect for major routes
            data.features.forEach(feature => {
                if (feature.properties.size !== 'Major') return;

                if (feature.geometry.type === 'MultiLineString') {
                    feature.geometry.coordinates.forEach(line => {
                        const latlngs = line.map(coord => [coord[1], coord[0]]);
                        const glow = L.polyline(latlngs, {
                            color: '#00d4ff',
                            weight: 8,
                            opacity: 0.12,
                            lineCap: 'round',
                            lineJoin: 'round'
                        });
                        hyperlaneGlowLayer.addLayer(glow);
                    });
                } else if (feature.geometry.type === 'LineString') {
                    const latlngs = feature.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    const glow = L.polyline(latlngs, {
                        color: '#00d4ff',
                        weight: 8,
                        opacity: 0.12,
                        lineCap: 'round',
                        lineJoin: 'round'
                    });
                    hyperlaneGlowLayer.addLayer(glow);
                }
            });

            hyperlaneGlowLayer.addTo(map);
            hyperlanesLayer.addTo(map);
        }

        // ============================================
        // PLANET MARKERS
        // ============================================
        function createPlanetMarkers(data) {
            markersLayer = L.geoJSON(data, {
                pointToLayer: (feature, latlng) => {
                    const props = feature.properties;
                    const intensity = props.intensity || 1;
                    const color = getRegionColor(props.region);

                    const marker = L.circleMarker(latlng, {
                        radius: 2 + intensity * 1.2,
                        fillColor: color,
                        color: color,
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    marker.feature = feature;
                    return marker;
                },
                coordsToLatLng: coords => L.latLng(coords[1], coords[0]),
                onEachFeature: (feature, layer) => {
                    layer.on('click', () => updateSystemInfo(feature.properties));

                    layer.on('mouseover', function() {
                        this.setStyle({ weight: 3, fillOpacity: 1 });
                        this.bringToFront();
                    });

                    layer.on('mouseout', function() {
                        this.setStyle({ weight: 1, fillOpacity: 0.8 });
                    });

                    const props = feature.properties;
                    layer.bindTooltip(`
                        <div class="popup-title">${props.name}</div>
                        <div class="popup-detail"><span>Region:</span> ${props.region || 'Unknown'}</div>
                        ${props.sector ? `<div class="popup-detail"><span>Sector:</span> ${props.sector}</div>` : ''}
                    `, {
                        className: 'custom-tooltip',
                        direction: 'top',
                        offset: [0, -5]
                    });
                }
            });

            markersLayer.addTo(map);
        }

        // ============================================
        // MAP EVENTS
        // ============================================
        map.on('moveend', debouncedUpdateMarkers);
        map.on('zoomend', debouncedUpdateMarkers);

        map.on('mousemove', function(e) {
            const lat = e.latlng.lat.toFixed(2);
            const lng = e.latlng.lng.toFixed(2);
            document.getElementById('coords').textContent = `COORDS: ${lng}, ${lat}`;
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            updateLoadingBar(10);

            try {
                // Load data
                const [planetsResponse, hyperlanesResponse] = await Promise.all([
                    fetch('data/planets.geojson'),
                    fetch('data/hyperlanes.geojson')
                ]);

                updateLoadingBar(40);

                const planets = await planetsResponse.json();
                const hyperlanes = await hyperlanesResponse.json();

                updateLoadingBar(60);

                planetsData = planets.features;
                hyperlanesData = hyperlanes.features;

                // Update stats
                document.getElementById('planet-count').textContent = planetsData.length.toLocaleString();
                document.getElementById('route-count').textContent = hyperlanesData.length;

                // Setup UI
                setupQuickJumps();
                setupFilters();

                updateLoadingBar(70);

                // Create layers
                labelsLayer = L.layerGroup().addTo(map);

                createHyperlanes(hyperlanes);
                updateLoadingBar(85);

                createPlanetMarkers(planets);
                updateLoadingBar(95);

                // Initial render
                updateVisibleMarkers();

                updateLoadingBar(100);

                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                }, 300);

            } catch (error) {
                console.error('Failed to load galactic data:', error);
                document.querySelector('.loading-text').textContent = 'Error loading data...';
            }
        }

        init();
    </script>
</body>
</html>
